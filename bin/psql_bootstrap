#!/bin/bash -eu

# Run command: PROJECT_NAME=test SU_PASSWORD=test HOSTNAME=127.0.0.1 ./psql_bootstrap

psql --username=$POSTGRES_USER -h $HOSTNAME -d postgres << EOF
DROP DATABASE IF EXISTS ${PROJECT_NAME};
DROP USER IF EXISTS ${PROJECT_NAME}_su;
DROP USER IF EXISTS ${PROJECT_NAME}_w;
DROP USER IF EXISTS ${PROJECT_NAME}_r;

CREATE DATABASE ${PROJECT_NAME};

CREATE USER ${PROJECT_NAME}_su WITH PASSWORD '${SU_PASSWORD}';

GRANT ALL PRIVILEGES ON DATABASE ${PROJECT_NAME} TO ${PROJECT_NAME}_su;
EOF

psql --username=$POSTGRES_USER -h $HOSTNAME -d $PROJECT_NAME -X << EOF
GRANT ALL ON SCHEMA public TO ${PROJECT_NAME}_su;
CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;
EOF

if [[ ! -v W_PASSWORD ]]; then
psql --username=$POSTGRES_USER -h $HOSTNAME -d $PROJECT_NAME << EOF
CREATE USER ${PROJECT_NAME}_w WITH PASSWORD '${W_PASSWORD}';
GRANT USAGE ON SCHEMA public TO ${PROJECT_NAME}_w;
GRANT INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO ${PROJECT_NAME}_w CASCADE;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT INSERT, UPDATE ON TABLES TO ${PROJECT_NAME}_w CASCADE;
GRANT USAGE, SELECT, UPDATE ON ALL SEQUENCES IN SCHEMA public TO ${PROJECT_NAME}_w CASCADE;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT, UPDATE ON SEQUENCES TO ${PROJECT_NAME}_w CASCADE;
EOF
fi

if [[ ! -v R_PASSWORD ]]; then
psql --username=$POSTGRES_USER -h $HOSTNAME -d $PROJECT_NAME << EOF
CREATE USER ${PROJECT_NAME}_r WITH PASSWORD '${R_PASSWORD}';
GRANT USAGE ON SCHEMA public TO ${PROJECT_NAME}_r;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO ${PROJECT_NAME}_r CASCADE;
GRANT SELECT, USAGE ON ALL SEQUENCES IN SCHEMA public TO ${PROJECT_NAME}_r CASCADE;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO ${PROJECT_NAME}_r CASCADE;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, USAGE ON SEQUENCES TO ${PROJECT_NAME}_r CASCADE;
EOF
fi
